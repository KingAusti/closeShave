# Backend Development Dockerfile with hot reload support
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv - download and install to a known location
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    mkdir -p /usr/local/bin && \
    if [ -f /root/.cargo/bin/uv ]; then \
        cp /root/.cargo/bin/uv /usr/local/bin/uv; \
    else \
        find /root -name uv -type f -executable 2>/dev/null | head -1 | xargs -I {} cp {} /usr/local/bin/uv; \
    fi && \
    chmod +x /usr/local/bin/uv
ENV PATH="/usr/local/bin:/root/.cargo/bin:${PATH}"

# Set working directory
WORKDIR /app

# Copy dependency files first (for better layer caching)
COPY pyproject.toml ./

# Create virtual environment
RUN uv venv /opt/venv
ENV PATH="/opt/venv/bin:${PATH}"

# Copy application code (needed for editable install)
COPY . .

# Install dependencies and application
RUN uv pip install -e ".[dev]"

# Install Playwright browsers (for development/testing)
RUN playwright install chromium
RUN playwright install-deps chromium

# Create directories for data and logs
RUN mkdir -p /app/data /app/logs

# Expose port
EXPOSE 8000

# Use uvicorn with reload for development
CMD ["uvicorn", "app.main:app", "--reload", "--host", "0.0.0.0", "--port", "8000"]

